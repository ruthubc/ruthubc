
---
title: "Weight Vs Colony Size Results with instar as numeric"
author: "Ruth Sharpe"
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r docSettings, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = "", message = FALSE)
modelList <-  list(test = c(), fullModel = c())
no_nest <- nlevels(spidersMul$NestID)
	
```


Leg Vs. Colony Size
--------------------

```{r LegNS, results='asis',  echo = FALSE}
##### Leg length vs colony size

FullModel <- lmer(logLeg ~ logCtFm + InstarNumber + logCtFm:InstarNumber + logCtFm:InstarNumber:InstarSex +  
    			(1 | NestID), data = spidersMul, REML = FALSE)

NSModel <- update(FullModel, .~. - logCtFm -logCtFm:InstarNumber - logCtFm:InstarNumber:InstarSex)


NSResults <- outputResultsWord(FullModel, NSModel)

modelList$test <- c(modelList$test, "Leg length")
modelList$fullModel <- c(modelList$fullModel, docxFmula(FullModel))

	
```
The model with the lowest AIC had colony size x instar age and the
three-way interaction nest size x instar age x instar sex as fixed effects.
Using this as the full model and all the terms that include nest size removed
as the reduced model in the likelihood ratio test, we found that leg length increases as colony size
increases (lmer; $\chi$^2^~`r NSResults[[1]]` ,`r NSResults[[2]]`~= `r NSResults[[3]]`, p = `r NSResults[[4]]` `r NSResults[[5]]`, figure 1), 
but this effect was only detectable in the older instars (Table 1). 


```{r LegInstarNumber, results='asis',  echo = FALSE}
##### Leg length vs instar

InstarModel <- update(FullModel, .~. - InstarNumber -logCtFm:InstarNumber - logCtFm:InstarNumber:InstarSex)

InstarResults <- outputResultsWord(FullModel, InstarModel)
	
```

Not surprisingly, leg length was significantly correlated with instar age (lmer; $\chi$^2^~`r InstarResults[[1]]`
,`r InstarResults[[2]]`~= `r InstarResults[[3]]`, p = `r InstarResults[[4]]`
`r InstarResults[[5]]`).


```{r LegInstarSex, results='asis',  echo = FALSE}
##### Leg length vs instar

InstarSexModel <- update(FullModel, .~. - logCtFm:InstarNumber:InstarSex)

InstarSexResults <- outputResultsWord(FullModel, InstarModel)
	
```

In addition, the interaction colony size x instar age x instar sex was
significant, (lmer; $\chi$^2^~`r InstarSexResults[[1]]`
,`r InstarSexResults[[2]]`~= `r InstarSexResults[[3]]`, p =
`r InstarSexResults[[4]]` `r InstarSexResults[[5]]`), with male leg size
changing faster with colony size compared to females (figure 1).



```{r LegIndInstar, results='asis',  echo = FALSE}
##### Leg length vs interaction

FullModel <- lmer(logLeg ~  logCtFm +  (1|NestID)  , data = subset(spidersMul, Instar == "Adult"))
RedModel <- lmer(logLeg ~  (1|NestID)  , data = subset(spidersMul, Instar == "Adult"))

AdultRes <- outputResultsWord(FullModel, RedModel)

FullModel <- lmer(logLeg ~  logCtFm +  (1|NestID)  , data = subset(spidersMul, Instar == "Sub2"))
RedModel <- lmer(logLeg ~  (1|NestID)  , data = subset(spidersMul, Instar == "Sub2"))

Sub2Res <- outputResultsWord(FullModel, RedModel)

FullModel <- lmer(logLeg ~  logCtFm +  (1|NestID)  , data = subset(spidersMul, Instar == "Sub1"))
RedModel <- lmer(logLeg ~  (1|NestID)  , data = subset(spidersMul, Instar == "Sub1"))

Sub1Res <- outputResultsWord(FullModel, RedModel)

FullModel <- lmer(logLeg ~  logCtFm +  (1|NestID)  , data = subset(spidersMul, Instar == "Juv4"))
RedModel <- lmer(logLeg ~  (1|NestID)  , data = subset(spidersMul, Instar == "Juv4"))

Juv4Res <- outputResultsWord(FullModel, RedModel)

FullModel <- lmer(logLeg ~  logCtFm +  (1|NestID)  , data = subset(spidersMul, Instar == "AdMale"))
RedModel <- lmer(logLeg ~  (1|NestID)  , data = subset(spidersMul, Instar == "AdMale"))

AdMaleRes <- outputResultsWord(FullModel, RedModel)

FullModel <- lmer(logLeg ~  logCtFm +  (1|NestID)  , data = subset(spidersMul, Instar == "SubMale"))
RedModel <- lmer(logLeg ~  (1|NestID)  , data = subset(spidersMul, Instar == "SubMale"))

SubMaleRes <- outputResultsWord(FullModel, RedModel)
	
```

Testing each instar separately, the only juvenile stage 4 and subadult stage 1
spiders did not show a significant decrease in leg length with colony size (table
1). 

| Instar   |      $\chi$^2^        |  p value                                | 
|----------|---------------------|--------------------------------------| 
|Juv4 | `r (Juv4Res[[3]])` |   `r Juv4Res[[4]]` `r Juv4Res[[5]]`  | 
| Sub1 Female| `r (Sub1Res[[3]])` |   `r Sub1Res[[4]]` `r Sub1Res[[5]]`  | 
| Sub2 Female| `r (Sub2Res[[3]])` |   `r Sub2Res[[4]]` `r Sub2Res[[5]]`  | 
|Adult Female |  `r (AdultRes[[3]])` |`r AdultRes[[4]]` `r AdultRes[[5]]`  |  
|Sub Male| `r (SubMaleRes[[3]])` |   `r SubMaleRes[[4]]` `r SubMaleRes[[5]]`  | 
|Adult Male | `r (AdMaleRes[[3]])` |   `r AdMaleRes[[4]]` `r AdMaleRes[[5]]`  | 


Table 1: Statistical results of leg length against colony size for each
instar tested individually

```{r LegGraph, fig.height=7, fig.width=13}

FullModel <- lmer(logLeg ~  logCtFm + Instar + logCtFm:Instar  + 
				(1|NestID)  , data = spidersMul, REML = FALSE)



InstarGridGraph(spidersMul, "logLeg", "Leg Length - log transformed", "n", "", FullModel)

```
  
(@) Figure:  Leg length against colony size. Overall leg length increased with
colony size (p = `r NSResults[[4]]` `r NSResults[[5]]`), but only for the older instars (there was a
significant interaction with instar (p = `r InstarResults[[4]]`
`r InstarResults[[5]]`). N = `r no_nest` nests.


Condition Vs. Colony Size
--------------------


```{r CondNS, results='asis',  echo = FALSE}
##### conditionh vs colony size


FullModel <- lmer(condResiduals ~  logCtFm + logCtFm:InstarNumber  +  (1|NestID), data = spidersMul, REML = FALSE)
NSModel <- update(FullModel, ~ . - logCtFm - logCtFm:InstarNumber)

NSResults <- outputResultsWord(FullModel, NSModel)

modelList$test <- c(modelList$test, "Condition")
modelList$fullModel <- c(modelList$fullModel, docxFmula(FullModel))

	
```
The model with the lowest AIC included instar age x colony size interaction, but did not include instar sex. Colony size was significant (lmer; $\chi$^2^~`r NSResults[[1]]`,`r NSResults[[2]]`~ =
`r NSResults[[3]]`, p = `r NSResults[[4]]` `r NSResults[[5]]`) 



```{r ConditionInteraction, results='asis',  echo = FALSE}
##### Leg length vs instar


IntModel <- update(FullModel, . ~ . - logCtFm )
IntResults <- outputResultsWord(FullModel, IntModel)
		
	
```
and there was a significant interaction between instar and colony size (lmer; $\chi$^2^~`r IntResults[[1]]`,`r IntResults[[2]]`~ =
`r IntResults[[3]]`, p = `r IntResults[[4]]` `r IntResults[[5]]`), with condition appearing to decrease faster with nest size as the instars 
increase in age (figure 3).

```{r ConditionAdultOnly, results='asis',  echo = FALSE}

FullModelAdOnly <- lmer(condResiduals ~  logCtFm +  (1|NestID), data = subset(spidersMul, Instar == "Adult"), REML = FALSE)
RedModAd <- update(FullModelAdOnly, .~. - logCtFm)
AdultResults <- outputResultsWord(FullModelAdOnly, RedModAd)
		
	
```

However, when performing ad-hoc tests on the instars individually we find that only adult 
condition decreases with colony size (lmer; $\chi$^2^~`r AdultResults[[1]]`,`r AdultResults[[2]]`~ =
`r AdultResults[[3]]`, p = `r AdultResults[[4]]` `r AdultResults[[5]]`).


```{r ConditionGraph, fig.height=7, fig.width=13}

InstarGridGraph(spidersMul, "condResiduals", "Individual Condition", "n", "", FullModel, "y")


```
  
(@)  Figure : Individual condition against colony size. Overall condition decreases with colony size
(p = `r NSResults[[4]]` `r NSResults[[5]]`) and there was a significant
interaction with instar(p = `r InstarResults[[4]]` `r InstarResults[[5]]`). 



```{r InstarConditionGraph, fig.height=7, fig.width=13}

a_predictDF <- expand.grid(logCtFm = seq(min(spidersMul$logCtFm), max(spidersMul$logCtFm), by = 0.1), 
		InstarNumber = c(4, 5, 6, 7), NestID = c("44.4EX12"))


a_predictDF$lmrPrd <- predict(FullModel, a_predictDF)

ggplot(data = a_predictDF, aes(x = logCtFm, y = lmrPrd, colour = as.factor(InstarNumber))) + geom_line(size = 1) + mytheme +
		ylab("Predicted Condition") + xlab("Log Count Females") + scale_colour_discrete(name = "Instar Age")

```
  
(@)  Figure : The results of the linear model showing individual condition of each instar age against colony size with both sexes combined as instar sex was insignificant. 
However only adults had a significant effect.  N = `r no_nest` nests.



Within Colony Variance Vs. colony size
--------------------

### Leg Length Variance


```{r LegLenVarNS, results='asis',  echo = FALSE}
##### Leg length vs colony size

minN <- 2
legVarUpdate <- subset(legVar, N > minN)
totSpis <- sum(legVarUpdate$N)
legVarUpdate$lmrWgts <- legVarUpdate$N/ totSpis



FullModel <- lmer(relativeVar ~ logCtFm + InstarNumber + InstarNumber:InstarSex + logCtFm:InstarNumber + I(InstarNumber^2) + (1|NestID), weights = lmrWgts,
    	data = legVarUpdate, REML = FALSE)

modelList$test <- c(modelList$test, "Leg variance")
modelList$fullModel <- c(modelList$fullModel, docxFmula(FullModel))


NSModel <- update(FullModel, . ~ . - (logCtFm + logCtFm:InstarNumber))

NSResults <- outputResultsWord(FullModel, NSModel)	
```
Note: Rows removed with `r minN` or fewer data points.

The model with the lowest AIC value had instar age  x instar sex, 
nest size x instar age and the square of instar age as fixed effects.

Nest size combined with the nest size x instar age interaction was significant
(lmer; $\chi$^2^~`r NSResults[[1]]` ,`r NSResults[[2]]`~= `r NSResults[[3]]`, p
= `r NSResults[[4]]``r NSResults[[5]]`).


```{r LegLenVarInstarNumber, results='asis',  echo = FALSE}
##### Leg length vs colony size

InstModel <- update(FullModel, . ~ . - ( InstarNumber + InstarNumber:InstarSex + logCtFm:InstarNumber + I(InstarNumber^2)))

InstResults <- outputResultsWord(FullModel, InstModel)	
```

Tested together all the instar age terms, including the square of the instar
age, were significant (lmer; $\chi$^2^~`r InstResults[[1]]` ,`r InstResults[[2]]`~=
`r InstResults[[3]]`, p = `r InstResults[[4]]` `r InstResults[[5]]`) 
with the variance in leg length within nests being a curved function, peaking at
subadult instars (figure 5).

```{r LegLenVarInstarSex, results='asis',  echo = FALSE}
##### Leg length vs colony size

InstSexModel <- update(FullModel, . ~ . - (InstarNumber:InstarSex))

InstSexResults <- outputResultsWord(FullModel, InstSexModel)	
```

However, even though it was included in the lowest AIC model, the instar age x
instar sex interaction was not significant (lmer;
$\chi$^2^~`r InstSexResults [[1]]` ,`r InstSexResults [[2]]`~=
`r InstSexResults [[3]]`, p = `r InstSexResults [[4]]`
`r InstSexResults [[5]]`). Doing adhoc tests on each instar age individually
against nest size we found that none were significant (figure 4).

```{r legVarGraph, fig.height=7, fig.width=13}


InstarGridGraph(legVarUpdate, "relativeVar", "Variance in leg length", "n", "", FullModel, "y")

```
  
(@)  Figure : Variance in leg length against colony size. N = `r no_nest` nests.



```{r LegVarByInstarGraph, fig.height=4, fig.width=5, echo = FALSE}

#plot <- ggplot(data = legVarUpdate, aes(x = InstarNumber, y = relativeVar, group = Instar, fill = InstarSex)) +
#	labs(x = "Instar") + labs(y = "Variance in Leg Length") + geom_boxplot() + mytheme


#InstarModel
InstarOnlyModel <- lmer(relativeVar ~InstarNumber + I(InstarNumber^2) + (1|NestID), weights = lmrWgts,
    	data = legVarUpdate, REML = FALSE)
#anova(InstarOnlyModel)

a_predictDF <- expand.grid(InstarNumber = seq(4, 7, by = 0.1),  NestID = c("44.4EX12"))


a_predictDF$lmrPrd <- predict(InstarOnlyModel, a_predictDF)
plot <- ggplot(data = a_predictDF, aes(x = InstarNumber, y = lmrPrd)) + 
		labs(x = "Instar") + labs(y = "Variance in Leg Length") + geom_line() + mytheme

plot <- plot + geom_boxplot(data = legVarUpdate, aes(x = InstarNumber, y = relativeVar, group = Instar, fill = InstarSex)) + 
		scale_x_continuous(breaks=c(3,4,5,6,7, 8))

plot + geom_line(data = a_predictDF, aes(y= lmrPrd), size = 0.5)


```

(@) Figure :Leg length variance within colonies by instar. Overlaid is the
linear model with a significat quadratic instar term.


### Condition Variance

```{r CondVar, results='asis',  echo = FALSE, message = FALSE, warning = FALSE}

# formatting the data
totSpis<- sum(condBootVar$N)
condBootVar$lmrWgts <- condBootVar$N/totSpis
condBootVar$bootVarTrans <- asin(sqrt(condBootVar$bootSD_var))
condBootVar$bootVarTrans <- condBootVar$bootVarTrans*100 # Making variance a percentage
condBootVar$bootVarTrans <- condBootVar$bootVarTrans +1 # have to add a small amount or glmer "can't find starting values"

# running the model
condBootFormula <-  bootVarTrans ~ logCtFm + InstarNumber:InstarSex + InstarSex:I(InstarNumber^2)
varBootCondMod <- glmmPQL(condBootFormula, ~1|NestID, family = gaussian(link = "log"), data = condBootVar, weights = lmrWgts, niter = 10)		
varBootCondAnova <- addStarsOnly_anova(varBootCondMod)


# seperating the results for easier printing below
NSCondRes <- varBootCondAnova[which(varBootCondAnova$parameters == "logCtFm"),]
InstarSexCondRes <- varBootCondAnova[which(varBootCondAnova$parameters == "InstarNumber:InstarSex"),]
InstarSexSqrCondRes <- varBootCondAnova[which(varBootCondAnova$parameters == "InstarSex:I(InstarNumber^2)"),]

	
```
Only colony size, instar age by sex interacion and instar age squared by sex
were significant.


Colony size was significant (glmmPQR; $\chi$^2^~`r NSCondRes$Df`~ =
`r NSCondRes$Chisq`, p `r NSCondRes$pValue` `r NSCondRes$stars`),

as was instar age crossed with sex (glmmPQR; $\chi$^2^~`r InstarSexCondRes$Df`~
= `r InstarSexCondRes$Chisq`, p `r InstarSexCondRes$pValue`
`r InstarSexCondRes$stars`) 

and instar age squared crossed with sex (glmmPQR;
$\chi$^2^~`r InstarSexSqrCondRes$Df`~ = `r InstarSexSqrCondRes$Chisq`, p
`r InstarSexSqrCondRes$pValue` `r InstarSexSqrCondRes$stars`).


```{r ConditionVarGraph, fig.height=7, fig.width=13}


InstarGridGraph(condBootVar, "bootVarTrans", "Variance in Condition", "n", "", varBootCondMod, "y")

```
  
(@)  Figure : Variance in condition against colony size, n = `r no_nest` nests.


```{r instarCondVarGraph, fig.height=4, fig.width=5, echo = FALSE}

		
#InstarOnlyModel <- lmer(relativeVar ~InstarNumber + I(InstarNumber^2) + (1|NestID), weights = lmrWgts, data = condVarUpdate, REML = FALSE)

		
#a_predictDF <- expand.grid(InstarNumber = seq(4, 7, by = 0.1),  NestID = c("44.4EX12"))
		
		
#a_predictDF$lmrPrd <- predict(InstarOnlyModel, a_predictDF)
		
		
		
#plot <- ggplot(data = a_predictDF, aes(x = InstarNumber, y = lmrPrd)) + 
		#labs(x = "Instar") + labs(y = "Variance in Condition") + geom_line() + mytheme
		
plot <- plot + geom_boxplot(data = condBootVar, aes(x = InstarNumber, y = bootVarTrans, group = Instar, fill = InstarSex)) + 
		scale_x_continuous(breaks=c(3,4,5,6,7, 8))
#plot + geom_line(data = a_predictDF, aes(y= lmrPrd), size = 0.5)
		
```

(@) Figure :Condition Length variance within colonies by instar. Overlaid is the
linear model with a significant quadratic term.






Original Colony Vs Propagule
============

```{r LegSing, results='asis',  echo = FALSE}
##### Leg length vs colony size


FullModel <- lmer(logLeg ~  type  +  (1|NestID) + (1|OrigNest) , data = nestsToTestSig, REML = FALSE)
NSModel <- lmer(logLeg ~   (1|NestID) + (1|OrigNest) , data = nestsToTestSig, REML = FALSE)

NSResults <- outputResultsWord(FullModel, NSModel)

modelList$test <- c(modelList$test, "Single nest leg")
modelList$fullModel <- c(modelList$fullModel, docxFmula(FullModel))

	
```
  
Leg length was larger in propagules compared to the source colony (lmer;
$\chi$^2^~`r NSResults[[1]]`,`r NSResults[[2]]`~= `r NSResults[[3]]`, p =
`r NSResults[[4]]` `r NSResults[[5]]`).



```{r CondSing, results='asis',  echo = FALSE}
##### Leg length vs colony size


FullModel <- lmer(condResiduals ~  type  +  (1|NestID) + (1|OrigNest) , data = nestsToTestSig, REML = FALSE)
NSModel <- lmer(condResiduals ~  (1|NestID) + (1|OrigNest) , data = nestsToTestSig, REML = FALSE)

NSResults <- outputResultsWord(FullModel, NSModel)

modelList$test <- c(modelList$test, "Single nest condition")
modelList$fullModel <- c(modelList$fullModel, docxFmula(FullModel))
	
```

as was condition (lmer; $\chi$^2^~`r NSResults[[1]]`,`r NSResults[[2]]`~=
`r NSResults[[3]]`, p = `r NSResults[[4]]` `r NSResults[[5]]`), with those in
propagules having a greater condition compared to those in the source colony.

```{r SingGraphs, fig.height=6, fig.width=12}

p1 <- ggplot(nestsToTestSigCond, aes(x=type, y=condResiduals)) + geom_boxplot() + 
		ylab("Individual Condition") + mytheme+ theme(axis.title.x = element_blank()) +
		scale_x_discrete(breaks=c("multiple", "single"), labels=c("source: multiple", "propagules: single"))

p2 <- ggplot(nestsToTestSig, aes(x=type, y=logLeg)) + geom_boxplot()  +
		mytheme +  theme(axis.title.x = element_blank()) +
		scale_x_discrete(breaks=c("multiple", "single"), labels=c("source: multiple", "propagules: single"))


grid.arrange(p1, p2, ncol = 2)


```
  
(@) Figure: Condition and leg length of adult females in propagues and their
source colony


Propagule survival
--------------------

We found that colony with single female spiders had a very low survival rate
(figure 5).

```{r PropaguleSurvivalGraph, fig.height=4, fig.width=7}

ggsurvplot(prop.survfit,color = "#2E9FDF", break.time.by = 5, 
		xlab = "Days until propagule death", ylab = "Propagule survival probability",  censor = FALSE)

nProps <- nlevels(props$propID)
nOriginalNests <- nlevels(props$nestID)

```
  
(@) Figure:  The survival function of `r nProps` propagules from `r nOriginalNests`
source colonies.

List of full models used
-----------------------


```{r ModelTableForLA, results = 'asis'}

modelDF <- as.data.frame(modelList)
kable(modelDF, format = 'markdown')


```